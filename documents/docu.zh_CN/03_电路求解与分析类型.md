# 03 电路求解与分析类型

PE 的核心求解入口是 `phy_engine::circult`（拼写如此），位于 `include/phy_engine/circuits/circuit.h`。

## 1) `phy_engine::circult` 的职责

`circult` 同时管理：

- `environment env`：收敛/容差/温度等环境参数（`include/phy_engine/circuits/environment/environment.h`）
- `netlist::netlist nl`：器件与连线
- `analyze_type at`：分析类型（`include/phy_engine/circuits/analyze.h`）
- `analyzer_storage_t analyzer_setting`：各分析的参数（`include/phy_engine/circuits/analyzer/impl.h`）
- 求解器与内部缓存（Eigen SparseLU / MKL PardisoLU / 可选 CUDA）

常用方法：

- `set_analyze_type(analyze_type)`
- `get_analyze_setting()`：设置 TR/AC 等
- `get_netlist()`：搭网表
- `analyze()`：执行一次分析（返回 `bool`）
- `digital_clk()`：推进一次数字 tick（组合 settle + 时序更新）

## 2) 分析类型（`analyze_type`）

定义：`include/phy_engine/circuits/analyze.h`

- `OP`：直流工作点
- `DC`：直流（目前与 OP 类似，更多由模型决定行为）
- `AC`：交流小信号（频域；用复数）
- `ACOP`：先 OP 再 AC
- `TR`：瞬态（时间步进；需设置 `tr.t_step` 和 `tr.t_stop`）
- `TROP`：先做一次“瞬态工作点”，再继续 TR

### TR 的设置

`c.get_analyze_setting().tr.t_step` / `t_stop`（见 `include/phy_engine/circuits/analyzer/TR.h`）。

PE 的 TR 在 `analyze()` 内部会循环 `t_stop / t_step` 次，每次：

- 调用 `update_tr_step(dt)` 通知所有模型步长变化
- 增加 `tr_duration`
- 执行一次 `solve()`

示例：`test/0004.solver/tr.cpp`。

### AC 的设置与扫频结果

`include/phy_engine/circuits/analyzer/AC.h` 支持：

- `sweep = single/linear/log`
- `omega`（rad/s）
- `omega_start/omega_stop/points`

当 `sweep != single` 时，`circult::analyze()` 会把每个扫频点的解向量写入 `ac_sweep_results`：

- `circult::ac_sweep_point{ omega, x }`

示例（单点）：`test/0012.ac/ac_omega.cpp`。

## 3) 环境参数（容差/温度等）

头文件：`include/phy_engine/circuits/environment/environment.h`

常见字段：

- `V_eps_max` / `V_epsr_max`：电压绝对/相对容差（类似 SPICE 的 VNTOL/RELTOL）
- `I_eps_max` / `I_epsr_max`：电流绝对/相对容差（ABSTOL/RELTOL）
- `r_open`：开路等效电阻（用于开关/继电器等）
- `temperature` / `norm_temperature`：工作温度 / 标称温度

## 4) 数字时钟与混合节点

数字更新表：`include/phy_engine/circuits/digital/update_table.h`

`circult::digital_clk()` 的策略是：

1. 先跑 `before_all_clk`（用于时序模型/Verilog 模块等）
2. 再用 update-table 机制把“需要更新”的节点逐步出队，驱动组合逻辑 settle
3. 最后跑 `after_all_clk`

混合节点（既连接模拟 pin 又连接数字 pin）会被放入 `always_tables`，每个 tick 都会被重新处理。

## 5) 性能与可选特性（环境变量/CPU/GPU）

`include/phy_engine/circuits/circuit.h` 内部读取的环境变量：

- `PHY_ENGINE_PROFILE_SOLVE=1`：打印/统计求解阶段耗时（若实现侧有输出）
- `PHY_ENGINE_PROFILE_SOLVE_VALIDATE=1`：开启额外验证（若实现侧启用）
- `PHY_ENGINE_MNA_REUSE=0`：禁用 MNA pattern 复用（默认允许复用）

CUDA（若以 NVCC 编译并启用 `cuda_sparse_lu`）：

- `circult::set_cuda_policy(cuda_solve_policy)`：auto/cpu/cuda
- `circult::set_cuda_node_threshold(n)`：节点数阈值（超过才尝试 GPU）
- `PHY_ENGINE_CUDA_PINNED=1`：启用 pinned host memory（见 `include/phy_engine/circuits/solver/cuda_sparse_lu.h`）

