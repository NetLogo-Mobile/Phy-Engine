# 02 核心概念与数据结构

本章解释 PE 的核心数据结构，帮助你读懂 `include/phy_engine/` 的接口组织方式。

## 1) `netlist::netlist`：网表容器

头文件：`include/phy_engine/netlist/netlist.h`

- `models`：分块存储的 `model_base` 数组（减少频繁分配）
- `nodes`：分块存储的 `model::node_t` 数组
- `ground_node`：地节点（特殊节点，通常 `node_index == SIZE_MAX`）

网表是“连线图”，求解器不会替你自动连线：每个器件 pin 必须通过 `add_to_node()` 连接到某个 `node_t`。

## 2) `model_base`：类型擦除的器件包装

头文件：`include/phy_engine/model/model_refs/base.h`

- `model_base` 持有 `ptr`（虚表接口）和 `type`（normal/null…）
- `ptr->generate_pin_view()` 返回一段 `pin[]`，每个 pin 内含 `nodes` 指针（指向连接的 `node_t`）
- `ptr->generate_branch_view()` 返回 branch（电流未知量），用于 MNA
- `ptr->set_attribute/get_attribute` 统一暴露“参数/状态”，以 `model::variant` 表达

实践建议：日常搭电路只需：

- `add_model(nl, model::resistance{...})`
- `add_to_node(nl, *model, pin, node)`

其余大多属于模型实现/扩展层。

## 3) `node_t` / `pin` / `branch`

关键头文件：

- `include/phy_engine/model/node/node.h`：`node_t`，包含模拟电压或数字状态
- `include/phy_engine/model/pin/pin.h`：`pin`，保存 `node_t* nodes` 与 `model_base* model`
- `include/phy_engine/model/branch/branch.h`：`branch`，保存电流未知量（MNA 额外变量）

`node_t` 同时支持模拟与数字：

- `node_information.an.voltage`：模拟节点电压（复数，用于 AC）
- `node_information.dn.state`：数字 4 态（L/H/X/Z）
- `num_of_analog_node`：节点上连接的“模拟 pin”数量；为 0 表示纯数字节点；介于 0 和 `pins.size()` 表示混合节点（hybrid）

## 4) `variant`：统一参数/状态类型

头文件：`include/phy_engine/model/model_refs/variant.h`

`variant` 支持整型/浮点/布尔/数字 4 态。数字输入常见用法：

- `variant{.digital = digital_node_statement_t::H, .type = variant_type::digital}`

（示例见 `test/0015.verilog_compile/pe_synth_and2.cpp` 的辅助函数 `dv()`）

